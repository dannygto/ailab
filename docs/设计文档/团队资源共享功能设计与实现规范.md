# 团队资源共享功能设计与实现规范

*文档版本：1.0*  
*更新日期：2025年7月23日*

## 一、功能概述

团队资源共享功能旨在允许用户在不同团队间安全地共享各类资源，如实验模板、实验数据、设备配置和分析结果等。通过细粒度的权限控制和完整的操作审计，确保资源共享既方便又安全。

## 二、系统架构

### 2.1 整体架构

```
+-------------------+       +-------------------+       +-------------------+
|                   |       |                   |       |                   |
|    前端组件       |<----->|    后端服务       |<----->|    数据存储       |
|                   |       |                   |       |                   |
+-------------------+       +-------------------+       +-------------------+
        |                           |                           |
        |                           |                           |
        v                           v                           v
+-------------------+       +-------------------+       +-------------------+
|                   |       |                   |       |                   |
|  用户界面与交互   |       |   权限控制系统    |       |  团队资源数据库   |
|                   |       |                   |       |                   |
+-------------------+       +-------------------+       +-------------------+
```

### 2.2 核心组件

1. **资源共享前端组件**
   - TeamResourceSharing.tsx：共享资源对话框组件
   - TeamResourceManagement.tsx：资源管理组件
   - SharedResourcesList.tsx：已共享资源列表组件

2. **资源共享服务**
   - TeamResourceService：处理资源共享请求
   - ResourcePermissionService：管理资源权限
   - SharingAuditService：记录共享操作日志

3. **数据模型**
   - TeamResource：团队资源模型
   - ResourceSharing：资源共享关系模型
   - SharingPermission：共享权限模型
   - SharingAudit：共享操作审计模型

## 三、数据模型定义

### 3.1 TeamResource（团队资源）

```typescript
interface TeamResource {
  id: string;
  teamId: string;
  name: string;
  description: string;
  type: ResourceType;
  path: string;
  metadata: Record<string, any>;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
  isShared: boolean;
  sharingCount?: number; // 共享给的团队/用户数量
}

enum ResourceType {
  EXPERIMENT_TEMPLATE = 'experiment_template',
  EXPERIMENT_DATA = 'experiment_data',
  DEVICE_CONFIG = 'device_config',
  ANALYSIS_RESULT = 'analysis_result',
  CODE_SNIPPET = 'code_snippet',
  DOCUMENT = 'document',
  OTHER = 'other'
}
```

### 3.2 ResourceSharing（资源共享关系）

```typescript
interface ResourceSharing {
  id: string;
  resourceId: string;
  resourceType: ResourceType;
  sourceTeamId: string;
  targetType: SharingTargetType;
  targetId: string;
  permissionLevel: PermissionLevel;
  expiresAt?: Date;
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}

enum SharingTargetType {
  USER = 'user',
  TEAM = 'team',
  ROLE = 'role'
}

enum PermissionLevel {
  READ = 'read',
  EDIT = 'edit', 
  ADMIN = 'admin'
}
```

### 3.3 SharingAudit（共享操作审计）

```typescript
interface SharingAudit {
  id: string;
  operationType: SharingOperationType;
  resourceId: string;
  resourceType: ResourceType;
  sourceTeamId: string;
  targetType: SharingTargetType;
  targetId: string;
  permissionLevel: PermissionLevel;
  performedBy: string;
  performedAt: Date;
  details: string;
}

enum SharingOperationType {
  SHARE = 'share',
  UNSHARE = 'unshare',
  MODIFY_PERMISSION = 'modify_permission',
  ACCESS = 'access',
  EDIT = 'edit'
}
```

## 四、API 定义

### 4.1 资源共享API

#### 获取团队资源列表
```
GET /api/teams/{teamId}/resources
```

#### 获取团队资源详情
```
GET /api/teams/{teamId}/resources/{resourceId}
```

#### 添加团队资源
```
POST /api/teams/{teamId}/resources
```

#### 更新团队资源
```
PUT /api/teams/{teamId}/resources/{resourceId}
```

#### 删除团队资源
```
DELETE /api/teams/{teamId}/resources/{resourceId}
```

#### 共享团队资源
```
POST /api/teams/{teamId}/resources/{resourceId}/share
```
请求体:
```json
{
  "targetType": "user|team|role",
  "targetId": "string",
  "permissionLevel": "read|edit|admin",
  "expiresAt": "ISO8601 date string" // 可选
}
```

#### 取消资源共享
```
DELETE /api/teams/{teamId}/resources/{resourceId}/share/{sharingId}
```

#### 修改共享权限
```
PUT /api/teams/{teamId}/resources/{resourceId}/share/{sharingId}
```
请求体:
```json
{
  "permissionLevel": "read|edit|admin",
  "expiresAt": "ISO8601 date string" // 可选
}
```

#### 获取资源共享列表
```
GET /api/teams/{teamId}/resources/{resourceId}/shares
```

#### 获取我可访问的共享资源
```
GET /api/resources/shared-with-me
```

### 4.2 审计日志API

#### 获取资源共享审计日志
```
GET /api/audit/resource-sharing
```
查询参数:
```
resourceId (可选)
teamId (可选)
startDate (可选)
endDate (可选)
operationType (可选)
```

## 五、前端组件设计

### 5.1 TeamResourceSharing组件

该组件是一个模态对话框，用于设置资源共享选项。

**主要功能**:
- 选择共享目标（用户、团队或角色）
- 设置权限级别（读取、编辑、管理）
- 设置共享过期时间（可选）
- 显示当前共享状态
- 管理现有共享

**组件接口**:
```typescript
interface TeamResourceSharingProps {
  open: boolean;
  onClose: () => void;
  resource: TeamResource;
  teamId: string;
  onShareUpdated?: () => void;
}
```

**设计要点**:
- 使用选项卡区分不同共享目标类型
- 提供搜索功能以快速定位目标
- 权限选项使用明确的描述和图标
- 现有共享列表支持过滤和排序
- 提供批量操作功能

### 5.2 SharedResourcesList组件

显示当前用户可访问的所有共享资源。

**主要功能**:
- 列出所有共享给我的资源
- 按资源类型、来源团队等过滤
- 显示共享权限和过期时间
- 提供资源访问入口

**组件接口**:
```typescript
interface SharedResourcesListProps {
  filter?: {
    resourceType?: ResourceType[];
    teamId?: string;
    permissionLevel?: PermissionLevel[];
  };
  onResourceSelect?: (resource: TeamResource) => void;
}
```

## 六、后端实现规范

### 6.1 权限验证

所有资源访问必须经过权限验证，验证流程如下:

1. 验证用户身份
2. 检查用户是否为资源所属团队成员
3. 若不是，检查是否存在针对该用户的共享
4. 若无直接共享，检查用户所属团队是否有共享
5. 若无团队共享，检查用户角色是否有共享
6. 确定最终有效权限级别(取最高权限)

### 6.2 数据库索引

为确保查询性能，建立以下索引:

- TeamResource: (teamId, type)
- ResourceSharing: (resourceId), (targetType, targetId), (sourceTeamId)
- SharingAudit: (resourceId), (performedAt)

### 6.3 缓存策略

采用多级缓存策略提高性能:

1. 用户权限缓存: 缓存用户对资源的有效权限，有效期10分钟
2. 共享列表缓存: 缓存资源的共享列表，有效期5分钟
3. 资源元数据缓存: 缓存资源基本信息，有效期15分钟

缓存在以下情况下失效:
- 权限变更
- 共享关系新增或修改
- 资源元数据更新

## 七、安全考虑

### 7.1 防止权限提升

- 共享者不能授予比自己更高的权限
- admin权限只能由资源所有者或团队管理员授予
- 系统定期审计异常权限变更

### 7.2 敏感操作保护

- 批量共享操作需要二次确认
- 取消多个共享需要验证
- 敏感资源共享需要团队管理员批准

### 7.3 数据隔离

- 共享数据访问记录专门日志
- 不同权限级别访问不同API端点
- 防止共享链接泄露(使用临时令牌)

## 八、测试规范

### 8.1 单元测试

- 资源共享服务各方法的单元测试
- 权限验证逻辑的全面测试
- 边界条件和异常情况测试

### 8.2 集成测试

- 前后端交互测试
- 权限级联效果测试
- 大量共享情况下的性能测试

### 8.3 用户体验测试

- 共享操作流程测试
- 权限变更后的体验测试
- 异常提示信息测试

## 九、实现时间表

| 阶段 | 开始日期 | 结束日期 | 主要任务 |
|-----|---------|---------|--------|
| 设计确认 | 2025-07-23 | 2025-07-24 | 完成详细设计并获得审批 |
| 前端实现 | 2025-07-24 | 2025-07-28 | 实现核心共享组件和交互流程 |
| 后端实现 | 2025-07-24 | 2025-07-28 | 实现共享API和权限控制 |
| 审计日志 | 2025-07-26 | 2025-07-29 | 实现操作审计和日志查询 |
| 集成测试 | 2025-07-29 | 2025-07-30 | 进行端到端测试和性能验证 |
| 文档完善 | 2025-07-30 | 2025-07-31 | 完成用户文档和API文档 |

## 十、未来扩展计划

### 10.1 近期计划 (2025年8月)

- 添加共享资源使用分析功能
- 实现共享推荐系统
- 添加共享链接功能(类似分享链接)

### 10.2 中期计划 (2025年9月)

- 集成外部身份系统的共享
- 实现跨实例资源共享
- 添加共享模板和批量操作

### 10.3 远期计划 (2025年10月及以后)

- 实现基于AI的共享异常检测
- 提供共享资源版本控制
- 开发共享资源冲突解决机制

---

*文档编写：李开发  
审核：张架构  
批准：王项目*
