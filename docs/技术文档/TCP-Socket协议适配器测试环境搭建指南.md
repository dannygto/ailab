# TCP/Socket协议适配器测试环境搭建指南

**日期**: 2025-07-24
**作者**: AI实验室开发团队
**版本**: 1.0

## 1. 概述

本文档提供了TCP/Socket协议适配器测试环境的详细搭建指南，包括网络环境配置、设备准备和测试软件安装。按照本指南，可以在一天内完成完整测试环境的搭建工作。

## 2. 测试环境要求

### 2.1 硬件要求

| 设备类型 | 数量 | 说明 |
|---------|------|------|
| 测试服务器 | 1 | 运行测试软件的主机，8核CPU、16GB内存、256GB SSD |
| 网络交换机 | 1 | 支持VLAN和QoS，至少16个端口 |
| 无线接入点 | 1 | 支持802.11ac，2.4GHz和5GHz双频 |
| 串口转TCP转换器 | 2 | 用于连接串口设备 |
| USB转TCP转换器 | 2 | 用于连接USB接口设备 |
| 测试设备 | 5 | 详见下方测试设备列表 |
| 网络线缆 | 若干 | Cat6类别，多种长度 |
| 电源线 | 若干 | 适配各设备电源要求 |

### 2.2 测试设备列表

| 设备型号 | 设备类型 | 通信接口 | IP地址 | 端口 |
|---------|---------|----------|--------|------|
| GX-5000 | 电子测量设备 | TCP/IP | 192.168.1.100 | 4001 |
| OS-2500 | 光学分析设备 | TCP/IP | 192.168.1.101 | 5001 |
| MC-3000 | 机械控制设备 | 串口转TCP | 192.168.1.102 | 6001 |
| CH-7000 | 化学分析设备 | TCP/IP | 192.168.1.103 | 7001 |
| TH-1200 | 热学测试设备 | USB转TCP | 192.168.1.104 | 8001 |

### 2.3 软件要求

| 软件 | 版本 | 用途 |
|------|------|------|
| Node.js | 20.x | 运行测试脚本的JavaScript运行时 |
| TypeScript | 5.x | 编译TypeScript测试代码 |
| ts-node | 最新版 | 直接执行TypeScript文件 |
| Wireshark | 最新版 | 网络数据包分析 |
| TCP模拟器 | 1.x | 模拟TCP设备行为（无法使用真实设备时） |
| 串口调试工具 | 最新版 | 调试串口通信 |

## 3. 网络环境配置

### 3.1 网络拓扑

创建以下网络拓扑结构:

```
                 +----------------+
                 |  测试服务器    |
                 | 192.168.1.10   |
                 +-------+--------+
                         |
                         |
              +----------+-----------+
              |    网络交换机        |
              +---+------+------+---+
                  |      |      |
     +------------+      |      +------------+
     |                   |                   |
+----+-----+      +-----+------+      +-----+------+
| GX-5000  |      |  OS-2500   |      |  CH-7000   |
|192.168.1.100    |192.168.1.101      |192.168.1.103
+----------+      +------------+      +------------+
                         |
                  +------+-------+
                  | 串口转TCP转换器|
                  | 192.168.1.102 |
                  +------+-------+
                         |
                  +------+-------+
                  |   MC-3000    |
                  | (串口设备)    |
                  +------+-------+
                  
                  +------+-------+
                  | USB转TCP转换器|
                  | 192.168.1.104 |
                  +------+-------+
                         |
                  +------+-------+
                  |   TH-1200    |
                  | (USB设备)     |
                  +------+-------+
```

### 3.2 网络配置步骤

1. **交换机配置**:
   - 将交换机恢复出厂设置
   - 配置管理IP为192.168.1.1
   - 创建测试VLAN (VLAN ID: 100)
   - 配置所有端口为VLAN 100成员
   - 启用端口QoS，优先处理测试流量

2. **无线接入点配置**:
   - 设置SSID为"TCP-Socket-Test"
   - 配置WPA2-PSK加密，密码为"TCPSocket2025Test"
   - 将无线接入点IP设置为192.168.1.2
   - 关闭DHCP服务
   - 将无线网络绑定到VLAN 100

3. **测试服务器配置**:
   - 配置有线网卡IP为192.168.1.10/24
   - 配置网关为192.168.1.1
   - 禁用所有不必要的服务和防火墙规则
   - 启用SSH服务用于远程访问

4. **串口转TCP转换器配置**:
   - 配置IP地址为192.168.1.102
   - 配置TCP端口为6001
   - 配置串口参数:
     - 波特率: 9600bps
     - 数据位: 8
     - 停止位: 1
     - 校验位: 无
     - 流控: 无

5. **USB转TCP转换器配置**:
   - 配置IP地址为192.168.1.104
   - 配置TCP端口为8001
   - 安装设备驱动程序
   - 配置USB通信参数

## 4. 设备准备

### 4.1 GX-5000电子测量设备

1. **硬件准备**:
   - 确认设备电源工作正常
   - 检查网络接口是否损坏
   - 清洁设备接口和显示屏

2. **软件配置**:
   - 将设备IP设置为192.168.1.100
   - 配置网络端口为4001
   - 更新设备固件到最新版本
   - 设置设备ID为"GX-5000-TEST"
   - 启用远程控制功能

3. **测试准备**:
   - 准备标准测试样本
   - 校准设备测量参数
   - 记录设备序列号和校准日期

### 4.2 OS-2500光学分析设备

1. **硬件准备**:
   - 检查光学元件是否清洁
   - 确认光源工作正常
   - 检查网络接口连接

2. **软件配置**:
   - 将设备IP设置为192.168.1.101
   - 配置网络端口为5001
   - 更新设备固件到最新版本
   - 加载标准光谱库

3. **测试准备**:
   - 准备光学校准样本
   - 执行设备自检程序
   - 记录光源使用时间

### 4.3 MC-3000机械控制设备

1. **硬件准备**:
   - 检查机械传动部件
   - 确认限位开关工作正常
   - 连接设备到串口转TCP转换器

2. **软件配置**:
   - 配置设备通信参数匹配串口转换器
   - 执行机械零位校准
   - 设置设备ID为"MC-3000-TEST"

3. **测试准备**:
   - 准备测试负载
   - 检查安全保护机制
   - 记录电机运行参数

### 4.4 CH-7000化学分析设备

1. **硬件准备**:
   - 检查试剂储存状态
   - 确认流体系统无泄漏
   - 检查网络接口连接

2. **软件配置**:
   - 将设备IP设置为192.168.1.103
   - 配置网络端口为7001
   - 更新设备固件到最新版本
   - 加载分析方法库

3. **测试准备**:
   - 准备标准溶液样本
   - 执行设备清洗程序
   - 记录关键部件使用时间

### 4.5 TH-1200热学测试设备

1. **硬件准备**:
   - 检查加热/冷却系统
   - 确认温度传感器工作正常
   - 连接设备到USB转TCP转换器

2. **软件配置**:
   - 安装设备驱动程序
   - 配置USB通信参数
   - 执行温度校准程序
   - 设置设备ID为"TH-1200-TEST"

3. **测试准备**:
   - 准备测试样本
   - 检查安全温度限制设置
   - 记录热循环次数

## 5. 测试软件安装

### 5.1 服务器软件安装

在测试服务器上安装以下软件:

1. **Node.js**:
   ```bash
   # 下载并安装Node.js
   wget https://nodejs.org/dist/v20.10.0/node-v20.10.0-x64.msi
   # 或使用包管理器
   choco install nodejs
   ```

2. **TypeScript和ts-node**:
   ```bash
   # 全局安装TypeScript和ts-node
   npm install -g typescript ts-node
   ```

3. **网络分析工具**:
   ```bash
   # 安装Wireshark
   choco install wireshark
   
   # 安装网络监控工具
   npm install -g netstat-monitor
   ```

### 5.2 测试项目配置

1. **克隆测试项目**:
   ```bash
   git clone https://github.com/ailab/tcp-socket-adapter-test.git
   cd tcp-socket-adapter-test
   ```

2. **安装项目依赖**:
   ```bash
   npm install
   ```

3. **配置测试参数**:
   - 创建设备配置文件:
     ```bash
     mkdir -p config/devices
     ```
   
   - 为每个设备创建配置文件，例如`config/devices/gx-5000.json`:
     ```json
     {
       "host": "192.168.1.100",
       "port": 4001,
       "deviceType": "electronic",
       "commandDelimiter": "\r\n",
       "responseTimeout": 3000,
       "secure": false,
       "reconnectAttempts": 3,
       "reconnectDelay": 1000,
       "connectionTimeout": 5000,
       "bufferSize": 8192,
       "idleTimeout": 60000,
       "keepAlive": true,
       "noDelay": true,
       "protocolSignatures": [
         {
           "pattern": "^GX-5000",
           "type": "electronic",
           "source": "identification"
         }
       ]
     }
     ```

4. **配置日志目录**:
   ```bash
   mkdir -p logs/test-results
   ```

## 6. 设备模拟器（备选方案）

如果无法获得实际物理设备，可以使用以下方法模拟设备行为:

### 6.1 设备模拟器安装

```bash
# 安装Node.js设备模拟器
npm install -g tcp-device-simulator
```

### 6.2 模拟器配置

为每个设备创建模拟配置文件，例如`simulator/gx-5000-sim.json`:

```json
{
  "deviceName": "GX-5000",
  "host": "0.0.0.0",
  "port": 4001,
  "responses": {
    "*IDN?": "GX-5000,ACME,12345,v1.2.3",
    "MEAS:VOLT:DC?": "4.982",
    "MEAS:CURR:DC?": "0.521",
    "MEAS:RES?": "1023.45"
  },
  "commandDelimiter": "\r\n",
  "responseDelay": {
    "min": 10,
    "max": 50
  },
  "errorProbability": 0.05
}
```

### 6.3 启动模拟器

```bash
# 启动GX-5000模拟器
tcp-device-simulator --config simulator/gx-5000-sim.json

# 启动所有设备模拟器
npm run start-simulators
```

## 7. 测试环境验证

完成环境搭建后，执行以下验证步骤:

### 7.1 网络连通性测试

1. **Ping测试**:
   ```bash
   # 测试服务器到各设备的连通性
   ping 192.168.1.100 -c 4
   ping 192.168.1.101 -c 4
   ping 192.168.1.102 -c 4
   ping 192.168.1.103 -c 4
   ping 192.168.1.104 -c 4
   ```

2. **端口连通性测试**:
   ```bash
   # 测试各设备端口连通性
   nc -zv 192.168.1.100 4001
   nc -zv 192.168.1.101 5001
   nc -zv 192.168.1.102 6001
   nc -zv 192.168.1.103 7001
   nc -zv 192.168.1.104 8001
   ```

### 7.2 基本通信测试

使用测试脚本执行基本连接测试:

```bash
# 测试GX-5000设备连接
.\scripts\run-test-v2.bat GX-5000 test

# 测试OS-2500设备连接
.\scripts\run-test-v2.bat OS-2500 test
```

### 7.3 环境监控配置

设置基本环境监控:

1. **资源使用监控**:
   ```bash
   # 安装监控工具
   npm install -g pm2
   
   # 配置服务器资源监控
   pm2 install pm2-server-monit
   ```

2. **网络流量监控**:
   ```bash
   # 启动网络流量监控
   pm2 start wireshark-capture.js
   ```

## 8. 故障排除

### 8.1 常见问题及解决方法

1. **网络连接问题**:
   - 检查网络线缆连接
   - 验证IP地址配置
   - 检查防火墙设置
   - 使用Wireshark抓包分析

2. **设备通信问题**:
   - 检查设备电源状态
   - 验证通信参数设置
   - 重启设备和转换器
   - 检查日志文件

3. **软件环境问题**:
   - 检查Node.js和TypeScript版本
   - 清理并重新安装项目依赖
   - 检查代码更新
   - 验证配置文件格式

### 8.2 联系支持

如果遇到无法解决的问题，请联系以下支持人员:

- 网络问题: 网络管理员 (网络部门分机: 8025)
- 设备问题: 硬件工程师 (硬件部门分机: 7103)
- 软件问题: 软件开发团队 (软件部门分机: 6200)

## 9. 附录

### 9.1 设备手册和参考资料

- [GX-5000用户手册](https://internal.ailab.com/docs/GX-5000-manual.pdf)
- [OS-2500操作指南](https://internal.ailab.com/docs/OS-2500-guide.pdf)
- [MC-3000维护手册](https://internal.ailab.com/docs/MC-3000-maintenance.pdf)
- [CH-7000技术规范](https://internal.ailab.com/docs/CH-7000-specs.pdf)
- [TH-1200参考文档](https://internal.ailab.com/docs/TH-1200-reference.pdf)

### 9.2 网络设备配置备份

所有网络设备的配置文件已备份至:
```
\\fileserver\projects\tcp-socket-test\network-configs\
```

### 9.3 测试环境检查清单

使用以下检查清单确保测试环境完全准备就绪:

- [ ] 所有设备电源已连接并开机
- [ ] 网络交换机配置完成
- [ ] 所有设备网络连接正常
- [ ] 测试服务器软件安装完成
- [ ] 设备配置文件已创建
- [ ] 基本连通性测试通过
- [ ] 测试脚本执行正常
- [ ] 日志目录已创建
- [ ] 监控系统已配置
- [ ] 测试团队已完成培训
