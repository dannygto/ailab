# TCP/Socket协议适配器模拟设备集成测试指南

## 1. 概述

本文档描述了如何使用设备模拟器对TCP/Socket协议适配器进行集成测试。该测试环境允许在没有实际硬件设备的情况下测试TCP/Socket协议适配器的功能和性能，为实际设备测试做准备。

## 2. 测试环境组件

测试环境由以下组件组成：

1. **设备模拟器**：模拟真实设备的TCP/IP服务端，响应命令并返回模拟数据
2. **集成测试脚本**：连接到模拟设备并执行一系列测试
3. **配置文件**：定义模拟设备的行为和响应
4. **启动脚本**：简化模拟器和测试的启动过程

## 3. 环境配置

### 3.1 模拟器配置文件

模拟器配置文件位于 `scripts/simulator/` 目录下，每个模拟设备有一个对应的JSON配置文件。配置示例：

```json
{
  "deviceName": "GX-5000",
  "host": "0.0.0.0",
  "port": 4001,
  "responses": {
    "*IDN?": "GX-5000,ACME,12345,v1.2.3",
    "MEAS:VOLT:DC?": "4.982",
    "MEAS:CURR:DC?": "0.521",
    "MEAS:RES?": "1023.45",
    "*": "ERROR: Invalid command"
  },
  "commandDelimiter": "\r\n",
  "responseDelay": {
    "min": 10,
    "max": 50
  },
  "errorProbability": 0.05
}
```

### 3.2 测试脚本配置

测试脚本自动从模拟器配置中获取设备信息，无需额外配置。脚本会测试基本连接、设备识别以及设备特定命令。

## 4. 运行测试

### 4.1 方法一：使用批处理脚本（推荐）

1. 双击 `scripts/run-simulator-device-test.bat`
2. 根据提示选择是否自动启动设备模拟器
3. 等待测试完成，查看测试结果和报告

### 4.2 方法二：手动运行

1. 启动设备模拟器：
   ```
   cd scripts
   node simulator/start-all-simulators.js
   ```

2. 在另一个命令行窗口中运行测试：
   ```
   cd scripts
   npx tsc --esModuleInterop simulator-device-test.ts
   node simulator-device-test.js
   ```

## 5. 测试内容

测试脚本会对每个模拟设备执行以下测试：

### 5.1 基本连接测试

- 测试与设备的基本TCP连接
- 测试设备识别指令（`*IDN?`）
- 测试断开连接

### 5.2 设备特定命令测试

- 针对不同设备类型测试特定命令
- 测试无效命令处理
- 测试命令超时处理

## 6. 测试报告

测试完成后，测试结果将显示在控制台，并保存在 `tests/reports/` 目录中。报告包含：

- 测试总数和通过/失败数量
- 每个设备的测试结果统计
- 详细的测试结果，包括响应时间
- 任何错误的详细信息

## 7. 自定义测试

### 7.1 添加新的模拟设备

1. 创建新的模拟器配置文件：`scripts/simulator/<设备名>-sim.json`
2. 在配置中定义设备名称、端口和命令响应
3. 重新启动模拟器和测试

### 7.2 自定义测试命令

修改 `simulator-device-test.ts` 中的 `testDeviceSpecificCommands` 函数，为特定设备类型添加或修改测试命令。

## 8. 故障排除

### 8.1 常见问题

- **模拟器启动失败**：检查端口是否被占用，尝试修改配置文件中的端口
- **连接超时**：确认模拟器正在运行且端口配置正确
- **测试脚本编译错误**：确认已安装TypeScript并检查代码语法

### 8.2 日志和调试

模拟器和测试脚本会在控制台输出详细日志。对于更深入的调试，可以修改脚本中的日志级别。

## 9. 总结

模拟设备集成测试是实际设备测试前的重要准备步骤，它可以帮助开发人员在控制环境中验证TCP/Socket协议适配器的功能，快速迭代开发而无需实际硬件设备。

-----

文档版本：1.0.0
更新日期：2025-07-24
作者：平台开发团队
